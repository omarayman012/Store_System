@model Store_Sys.Models.ViewModels.InFileViewModel

<!-- Bootstrap RTL + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    .icon-btn {
        --size: 36px;
        width: var(--size);
        height: var(--size);
        border-radius: 50%;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        cursor: pointer;
        transition: transform .2s ease, box-shadow .2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, .15);
        color: #fff;
    }

    .icon-add {
        background: #28c76f;
    }

    .icon-del {
        background: #ea5455;
    }

    .icon-btn:hover {
        transform: scale(1.12) rotate(5deg);
        box-shadow: 0 4px 8px rgba(0, 0, 0, .25);
    }

    .icon-btn:active {
        transform: scale(.95);
    }

    .icon-btn i {
        pointer-events: none;
    }
</style>
@if (ViewBag.Message != null)
{
    <div class="alert alert-info text-center">
        @ViewBag.Message
    </div>
}
<form asp-action="AddFile" asp-controller="InFiles" method="post">
    <div class="mt-5">
        <div id="personal-info" class="shadow p-3">
            <span class="bg-color d-inline-block px-2 mb-2">إضافة مستند جديد مدخل</span>
            <div class="row">
                <div class="col-sm-12 col-md-2 mt-3">
                    <label class="form-label">رقم المستند</label>
                    <input type="number" class="form-control" asp-for="InFile.DocumentNum" required />
                    <span asp-validation-for="InFile.DocumentNum" class="text-danger"></span>
                </div>
                <div class="col-sm-12 col-md-2 mt-3">
                    <label class="form-label">تاريخ المستند</label>
                    <input type="date" class="form-control" asp-for="InFile.Documentdate" @* value="@DateTime.Now.ToString("yyyy-MM-dd")" *@required />
                    <span asp-validation-for="InFile.Documentdate" class="text-danger"></span>
                </div>
                <div class="col-sm-12 col-md-2 mt-3">
                    <label class="form-label">اسم الجهة المجهزة</label>
                    <input type="text" class="form-control" asp-for="InFile.NameSupplier" required />
                    <span asp-validation-for="InFile.NameSupplier" class="text-danger"></span>

                </div>
                <div class="col-sm-12 col-md-2 mt-3">
                    <label class="form-label">رقم الطلب</label>
                    <input type="number" class="form-control" asp-for="InFile.OrderNum" required />
                    <span asp-validation-for="InFile.OrderNum" class="text-danger"></span>

                </div>
                <div class="col-sm-12 col-md-2 mt-3">
                    <label class="form-label">تاريخ الطلب</label>
                    <input type="date" class="form-control" asp-for="InFile.OrderDate" required />
                    <span asp-validation-for="InFile.OrderDate" class="text-danger"></span>

                </div>
                <div class="col-sm-12 col-md-2 mt-3">
                    <label class="form-label">رقم الموافقة على التجهيز</label>
                    <input type="number" class="form-control" asp-for="InFile.ApprovalNum" required />
                    <span asp-validation-for="InFile.ApprovalNum" class="text-danger"></span>

                </div>
                <div class="col-sm-12 col-md-2 mt-3">
                    <label class="form-label">تاريخ الموافقة على التجهيز</label>
                    <input type="date" class="form-control" asp-for="InFile.ApprovalDate" required />
                    <span asp-validation-for="InFile.ApprovalDate" class="text-danger"></span>

                </div>
                <div class="col-sm-12 col-md-2 mt-3">
                    <label class="form-label">مصدر الصرف</label>
                    <select asp-for="InFile.SourceId" class="form-select" asp-items="Model.SourcesList" required>
                        <option value="">اختر المصدر</option>
                    </select>
                    <span asp-validation-for="InFile.SourceId" class="text-danger"></span>

                </div>

                <div class="col-sm-12 col-md-2 mt-3">
                    <label class="form-label">اسم المستلم </label>
                    <input type="text" class="form-control" asp-for="InFile.TokenName" required />
                    <span asp-validation-for="InFile.TokenName" class="text-danger"></span>

                </div>

            </div>

            <hr>
            <h3 class="text-center my-3">إضافة مدخلات</h3>

            <table class="table table-striped align-middle text-center">
                <thead>
                    <tr>
                       
                        <th>اسم المادة</th>
                        <th>الوحدة</th>
                        <th>العدد</th>
                        <th>السعر</th>
                        <th>الثمن الإجمالي</th>
                     
                        <th>التفاصيل</th>
                        <td>
                            <button class="icon-btn icon-add" type="button"><i class="bi bi-plus-lg"></i></button>
                        </td>
                    </tr>
                </thead>
                <tbody id="subjectsBody">
                    <tr class="template-row">
                     
                        <td>
                            <select class="form-select material-select" name="Items[0].MaterialId" required>
                                <option value="">اختر اسم المادة…</option>
                                @foreach (var item in Model.MaterialsList)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                            <span class="text-danger" data-valmsg-for="Items[0].MaterialId" data-valmsg-replace="true"></span>
                        </td>
                        <td>
                            <select class="form-select units-select" name="Items[0].UnitsId" required>
                                <option value="">اختر الوحدة…</option>
                                @foreach (var item in Model.UnitsList)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                            <span class="text-danger" data-valmsg-for="Items[0].UnitsId" data-valmsg-replace="true"></span>
                        </td>
                        <td>
                            <input type="number" class="form-control  quantity" name="Items[0].Quantity" required />

                            <span class="text-danger" data-valmsg-for="Items[0].Quantity" data-valmsg-replace="true"></span>
                        </td>
                        <td>
                            <input type="number" class="form-control price" name="Items[0].Price" required />
                            <span class="text-danger" data-valmsg-for="Items[0].Price" data-valmsg-replace="true"></span>
                        </td>
                        <td>
                            <input type="number" class="form-control total" name="Items[0].Total" readonly />
                            <span class="text-danger" data-valmsg-for="Items[0].Total" data-valmsg-replace="true"></span>
                        </td>
                        <td><textarea class="form-control" name="Items[0].Details"></textarea></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>


            <div class="col-sm-12 mt-2">
                <input type="submit" class="form-control color-btn btn btn-primary" value="حفظ" />
            </div>
        </div>
    </div>
</form>


<!-- تحميل مكتبات الفاليديشن (jQuery + jQuery.validate + jQuery.validate.unobtrusive) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@3.2.11/dist/jquery.validate.unobtrusive.min.js"></script>
<!-- ‎Scripts ‎-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

@section Scripts {
    <script>
        $(document).on("input", ".quantity, .price", function () {
            let row = $(this).closest("tr"); // الصف الحالي
            let quantity = parseFloat(row.find(".quantity").val()) || 0;
            let price = parseFloat(row.find(".price").val()) || 0;
            let total = quantity * price;
            row.find(".total").val(total.toFixed(2)); // خانتين عشريتين
        });
    </script>
}
<!-- تحميل مكتبات الفاليديشن (jQuery + jQuery.validate + jQuery.validate.unobtrusive) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@3.2.11/dist/jquery.validate.unobtrusive.min.js"></script>
<script>
    $(document).ready(function () {
        let index = 1; // البداية من 1 لأن أول صف موجود هو [0]

        // عند الضغط على زر الإضافة
        $('.icon-add').on('click', function () {
            let templateRow = $('.template-row').first().clone();

            // تنظيف القيم
            templateRow.find('input, textarea, select').val('');
            templateRow.find('input.total').prop('readonly', true);
            templateRow.removeClass('template-row');

            // تحديث أسماء الحقول
            templateRow.find('select.material-select').attr('name', `Items[${index}].MaterialId`);
            templateRow.find('select.units-select').attr('name', `Items[${index}].UnitsId`);
            templateRow.find('input.quantity').attr('name', `Items[${index}].Quantity`);
            templateRow.find('input.price').attr('name', `Items[${index}].Price`);
            templateRow.find('input.total').attr('name', `Items[${index}].Total`);
            templateRow.find('textarea').attr('name', `Items[${index}].Details`);

            // تحديث رسائل التحقق
            templateRow.find('span[data-valmsg-for]').each(function () {
                let field = $(this).data('valmsg-for').split('.')[1]; // مثل Quantity أو MaterialId
                $(this).attr('data-valmsg-for', `Items[${index}].${field}`);
            });

            // زر الحذف
            templateRow.find('td:last').html('<button type="button" class="btn btn-danger btn-sm delete-row"><i class="bi bi-x-lg"></i></button>');

            // إضافة الصف
            $('#subjectsBody').append(templateRow);
            index++;
        });

        // حذف الصف عند الضغط على زر الحذف
        $('#subjectsBody').on('click', '.delete-row', function () {
            $(this).closest('tr').remove();
        });

        // تحديث الثمن الإجمالي تلقائيًا عند تغيير العدد أو السعر
        $('#subjectsBody').on('input', '.quantity, .price', function () {
            let row = $(this).closest('tr');
            let quantity = parseFloat(row.find('.quantity').val()) || 0;
            let price = parseFloat(row.find('.price').val()) || 0;
            row.find('.total').val((quantity * price).toFixed(2));
        });
    });
</script>
