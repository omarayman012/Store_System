<!-- Bootstrap RTL + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
@model Store_Sys.Models.ViewModels.InFileViewModel

<style>
    /* زر أيقونة دائري */
    .icon-btn {
        --size: 36px;
        width: var(--size);
        height: var(--size);
        border-radius: 50%;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        cursor: pointer;
        transition: transform .2s ease,box-shadow .2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,.15);
        color: #fff;
    }

    .icon-add {
        background: #28c76f;
    }
    /* أخضر */
    .icon-del {
        background: #ea5455;
    }
    /* أحمر */

    .icon-btn:hover {
        transform: scale(1.12) rotate(5deg);
        box-shadow: 0 4px 8px rgba(0,0,0,.25);
    }

    .icon-btn:active {
        transform: scale(.95);
    }

    .icon-btn i {
        pointer-events: none;
    }
</style>
<form asp-action="EditFile" asp-controller="InFiles" method="post">
    <input type="hidden" asp-for="InFile.Id" />

    <div class="mt-5">
        <div id="personal-info" class="shadow p-3">
            <span class="bg-color d-inline-block px-2 mb-2">تعديل مستند مدخل</span>

            <div class="row">
                <!-- رقم المستند -->
                <div class="col-sm-12 col-md-2 mt-3">
                    <label asp-for="InFile.DocumentNum" class="form-label"></label>
                    <input asp-for="InFile.DocumentNum" class="form-control" placeholder="أدخل رقم مستند" required />
                    <span asp-validation-for="InFile.DocumentNum" class="text-danger"></span>
                </div>

                <!-- تاريخ المستند -->
                <div class="col-sm-12 col-md-2 mt-3">
                    <label asp-for="InFile.Documentdate" class="form-label"></label>
                    <input asp-for="InFile.Documentdate" class="form-control" type="date" required />
                    <span asp-validation-for="InFile.Documentdate" class="text-danger"></span>
                </div>

                <!-- اسم الجهة المجهزة -->
                <div class="col-sm-12 col-md-2 mt-3">
                    <label asp-for="InFile.NameSupplier" class="form-label"></label>
                    <input asp-for="InFile.NameSupplier" class="form-control" required placeholder="أدخل اسم الجهة" />
                    <span asp-validation-for="InFile.NameSupplier" class="text-danger"></span>
                </div>

                <!-- رقم الطلب -->
                <div class="col-sm-12 col-md-2 mt-3">
                    <label asp-for="InFile.OrderNum" class="form-label"></label>
                    <input asp-for="InFile.OrderNum" class="form-control" required placeholder="أدخل رقم الطلب" />
                    <span asp-validation-for="InFile.OrderNum" class="text-danger"></span>
                </div>

                <!-- تاريخ الطلب -->
                <div class="col-sm-12 col-md-2 mt-3">
                    <label asp-for="InFile.OrderDate" class="form-label"></label>
                    <input asp-for="InFile.OrderDate" class="form-control" type="date" required />
                    <span asp-validation-for="InFile.OrderDate" class="text-danger"></span>
                </div>

                <!-- رقم الموافقة على التجهيز -->
                <div class="col-sm-12 col-md-2 mt-3">
                    <label asp-for="InFile.ApprovalNum" class="form-label"></label>
                    <input asp-for="InFile.ApprovalNum" class="form-control" required placeholder="أدخل رقم الموافقة" />
                    <span asp-validation-for="InFile.ApprovalNum" class="text-danger"></span>
                </div>

                <!-- تاريخ الموافقة على التجهيز -->
                <div class="col-sm-12 col-md-2 mt-3">
                    <label asp-for="InFile.ApprovalDate" class="form-label"></label>
                    <input asp-for="InFile.ApprovalDate" class="form-control" type="date" required />
                    <span asp-validation-for="InFile.ApprovalDate" class="text-danger"></span>
                </div>

                <!-- مصدر الصرف -->
                <div class="col-sm-12 col-md-2 mt-3">
                    <label asp-for="InFile.SourceId" class="form-label"></label>
                    <select asp-for="InFile.SourceId" asp-items="Model.SourcesList" class="form-select" required>
                        <option value="">اختر المصدر</option>
                    </select>
                    <span asp-validation-for="InFile.SourceId" class="text-danger"></span>
                </div>

                <!-- اسم  المستلم -->
                <div class="col-sm-12 col-md-2 mt-3">
                    <label asp-for="InFile.TokenName" class="form-label"></label>
                    <input asp-for="InFile.TokenName" class="form-control" required placeholder="أدخل اسم المستلم" />
                    <span asp-validation-for="InFile.TokenName" class="text-danger"></span>
                </div>
            </div>

            
            <h3 class="text-center my-3">تعديل مدخلات</h3>

            <!-- جدول المواد -->
            <table class="table table-striped align-middle text-center">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>اسم المادة</th>
                        <th>الوحدة</th>
                        <th>العدد</th>
                        <th>السعر</th>
                        <th>الثمن الإجمالي</th>
                        <th>تاريخ الإدخال</th>
                        <th>سنة التجهيز</th>
                        <th>التفاصيل</th>
                      @*   <td class="text-center">
                            <button type="button" class="icon-btn icon-add" title="إضافة صف"><i class="bi bi-plus-lg"></i></button>
                        </td> *@
                    </tr>
                </thead>

                <tbody id="subjectsBody">
                    @for (int i = 0; i < Model.Items.Count; i++)
                    {
                        <tr>
                            <input type="hidden" asp-for="Items[i].Id" />
                            <td class="row-index">@i + 1</td>
                            <td>
                                <select asp-for="Items[i].MaterialId" asp-items="Model.MaterialsList" class="form-select" required>
                                    <option value="" selected disabled>اختر اسم المادة…</option>
                                </select>
                            </td>
                            <td>
                                <select asp-for="Items[i].UnitsId" asp-items="Model.UnitsList" class="form-select" required>
                                    <option value="" selected disabled>اختر الوحدة…</option>
                                </select>
                            </td>
                            <td><input asp-for="Items[i].Quantity" class="form-control quantity" type="number" placeholder="0" /></td>
                            <td><input asp-for="Items[i].Price" class="form-control price" type="number" placeholder="0.00" /></td>
                            <td><input asp-for="Items[i].Total" class="form-control total" type="number" placeholder="0.00" readonly/></td>
                            <td><input asp-for="Items[i].EntryDate" class="form-control" type="date" /></td>
                            <td>
                                <select asp-for="Items[i].YearDateId" asp-items="Model.YearsList" class="form-select" required>
                                    <option value="" selected disabled>اختر السنة…</option>
                                </select>
                            </td>
                            <td><textarea asp-for="Items[i].Details" class="form-control" rows="1" placeholder="تفاصيل إضافية…"></textarea></td>
                          @*   <td>
                                <button type="button" class="icon-btn icon-del" title="حذف الصف"><i class="bi bi-x-lg"></i></button>
                            </td> *@
                        </tr>
                    }
                </tbody>
            </table>

            <div class="col-sm-12 mt-2">
                <input type="submit" class="form-control color-btn" value="حفظ" />
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <script>
        $(document).on("input", ".quantity, .price", function () {
            let row = $(this).closest("tr"); // الصف الحالي
            let quantity = parseFloat(row.find(".quantity").val()) || 0;
            let price = parseFloat(row.find(".price").val()) || 0;
            let total = quantity * price;
            row.find(".total").val(total.toFixed(2)); // خانتين عشريتين
        });
    </script>
}

<script>
    // /* ––– إعدادات عامة ––– */
    // const body   = document.getElementById('subjectsBody');
    // const addBtn = document.querySelector('.icon-add');

    // /* توليد قائمة السنوات */
    // function fillYears(select){
    //   const current=new Date().getFullYear();
    //   for(let y=current;y>=current-20;y--){
    //     const opt=document.createElement('option');
    //     opt.value=y;opt.textContent=y;
    //     select.appendChild(opt);
    //   }
    // }

    // /* إعادة الترقيم */
    // function refreshIndices(){
    //   body.querySelectorAll('tr').forEach((tr,i)=>{
    //     tr.querySelector('.row-index').textContent=i+1;
    //   });
    // }

    // /* إضافة صف جديد */
    // function addRow(){
    //   const template=body.querySelector('.template-row');
    //   const clone   =template.cloneNode(true);

    //   /* تفريغ القيم */
    //   clone.querySelectorAll('input,select,textarea').forEach(el=>el.value='');

    //   /* سنوات التجهيز */
    //   fillYears(clone.querySelector('select[name="supplyYear"]'));

    //   /* زر الحذف */
    //   clone.lastElementChild.innerHTML=
    //     `<button class="icon-btn icon-del" title="حذف الصف"><i class="bi bi-x-lg"></i></button>`;

    //   body.appendChild(clone);
    //   refreshIndices();
    // }

    // /* أحداث */
    // addBtn.addEventListener('click',addRow);

    // /* تفويض الحذف */
    // body.addEventListener('click',e=>{
    //   const delBtn=e.target.closest('.icon-del');
    //   if(delBtn){
    //     delBtn.closest('tr').remove();
    //     refreshIndices();
    //   }
    // });

    // /* تهيئة الصفّ الأوّل */
    // fillYears(document.querySelector('select[name="supplyYear"]'));
    // refreshIndices();
</script>
